name: ðŸ”¨ Build Check

# ÐžÑ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ workflow Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ð¸
# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾Ð¹ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹ Ñ Ð²Ð°ÑˆÐµÐ³Ð¾ ÑÐµÑ€Ð²ÐµÑ€Ð°
on:
  repository_dispatch:
    types: [build-check]
  workflow_dispatch:

jobs:
  build:
    name: ðŸ”¨ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ð¸
    runs-on: macos-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout ÐºÐ¾Ð´Ð°
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ’¾ ÐšÐµÑˆ SPM Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: ðŸ“‹ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÑ€ÐµÐ´Ðµ
        run: |
          echo "Xcode: $(xcodebuild -version)"
          echo "Swift: $(swift --version)"
          echo "macOS: $(sw_vers -productVersion)"

      - name: ðŸ”¨ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
        id: build
        run: |
          if [ -f "Package.swift" ]; then
            echo "ðŸ“¦ Swift Package Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½"
            swift build
          elif find . -maxdepth 1 -name "*.xcworkspace" | grep -q .; then
            WORKSPACE=$(find . -maxdepth 1 -name "*.xcworkspace" | head -n 1)
            WORKSPACE_NAME=$(basename "$WORKSPACE")
            SCHEME=$(xcodebuild -workspace "$WORKSPACE_NAME" -list | grep -A 1 "Schemes:" | tail -n 1 | xargs)
            echo "ðŸ”¨ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÑŽ workspace: $WORKSPACE_NAME, ÑÑ…ÐµÐ¼Ð°: $SCHEME"
            xcodebuild -workspace "$WORKSPACE_NAME" -scheme "$SCHEME" \
              -destination "platform=iOS Simulator,name=iPhone 16" \
              -configuration Debug clean build
          elif find . -maxdepth 1 -name "*.xcodeproj" | grep -q .; then
            PROJECT=$(find . -maxdepth 1 -name "*.xcodeproj" | head -n 1)
            PROJECT_NAME=$(basename "$PROJECT")
            SCHEME=$(xcodebuild -project "$PROJECT_NAME" -list | grep -A 1 "Schemes:" | tail -n 1 | xargs)
            echo "ðŸ”¨ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚: $PROJECT_NAME, ÑÑ…ÐµÐ¼Ð°: $SCHEME"
            xcodebuild -project "$PROJECT_NAME" -scheme "$SCHEME" \
              -destination "platform=iOS Simulator,name=iPhone 16" \
              -configuration Debug clean build
          else
            echo "âŒ Swift Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
            exit 1
          fi

      - name: ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ ÑÐ±Ð¾Ñ€ÐºÐ¸
        if: always()
        run: |
          if [ "${{ steps.build.outcome }}" == "success" ]; then
            echo "âœ… ÐŸÑ€Ð¾ÐµÐºÑ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐºÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½!"
          else
            echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ð¸!"
          fi

      - name: ðŸ“¤ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð° Ð½Ð° backend
        if: always()
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL }}
          BACKEND_TOKEN: ${{ secrets.BACKEND_TOKEN }}
        run: |
          cat > build-report.json <<EOF
          {
            "repository": "${{ github.repository }}",
            "branch": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "author": "${{ github.actor }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "workflow_run_id": "${{ github.run_id }}",
            "build_status": "${{ steps.build.outcome }}",
            "build_time": "${{ steps.build.outputs.time }}"
          }
          EOF

          if [ -n "$BACKEND_URL" ]; then
            curl -X POST "$BACKEND_URL/build-check" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $BACKEND_TOKEN" \
              -d @build-report.json
          else
            echo "âš ï¸ BACKEND_URL Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"
          fi
