name: üîç Code Review (Optimized)

# –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø–æ –∫–æ–º–∞–Ω–¥–µ —Å –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
on:
  repository_dispatch:
    types: [code-review]
  workflow_dispatch:  # –î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∏–∑ GitHub UI

jobs:
  code-analysis:
    name: üìä –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞
    runs-on: macos-latest
    timeout-minutes: 3  # 3 –º–∏–Ω—É—Ç—ã –º–∞–∫—Å–∏–º—É–º (180 —Å–µ–∫—É–Ω–¥)

    steps:
      # ========================================
      # 1. –ë—ã—Å—Ç—Ä—ã–π checkout (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç)
      # ========================================
      - name: üì• Checkout –∫–æ–¥–∞
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç - —ç–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏

      # ========================================
      # 2. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≥–æ—Ç–æ–≤—ã—Ö –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–≤ (3-5 —Å–µ–∫)
      # ========================================
      - name: üì¶ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        run: |
          echo "üì¶ –°–∫–∞—á–∏–≤–∞—é –≥–æ—Ç–æ–≤—ã–µ –±–∏–Ω–∞—Ä–Ω–∏–∫–∏..."
          mkdir -p tools

          # –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–®–ò –†–ï–ê–õ–¨–ù–´–ï –°–°–´–õ–ö–ò:
          curl -L "https://cloud.tstservice.tech/public.php/dav/files/ZqH5WExrajGwG3m" -o tools/swift-style-check
          curl -L "https://cloud.tstservice.tech/public.php/dav/files/DrxTd795z9fd9ef" -o tools/swift-dead-code
          curl -L "https://cloud.tstservice.tech/public.php/dav/files/DFDJGPgWeNbkbT5" -o tools/swift-memory-check

          # –î–µ–ª–∞–µ–º –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º–∏
          chmod +x tools/swift-style-check
          chmod +x tools/swift-dead-code
          chmod +x tools/swift-memory-check

          echo "‚úÖ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å–∫–∞—á–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã"

      # ========================================
      # 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–Ω–µ—à–Ω–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (~30 —Å–µ–∫)
      # ========================================
      - name: üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SwiftLint
        run: |
          echo "üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é SwiftLint..."
          brew install swiftlint
          echo "‚úÖ SwiftLint $(swiftlint version)"

      - name: üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Periphery
        run: |
          echo "üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Periphery..."
          PERIPHERY_VERSION="3.2.0"
          curl -L "https://github.com/peripheryapp/periphery/releases/download/${PERIPHERY_VERSION}/periphery-${PERIPHERY_VERSION}.zip" -o periphery.zip
          unzip -q periphery.zip
          sudo mv periphery /usr/local/bin/periphery
          sudo chmod +x /usr/local/bin/periphery
          rm periphery.zip
          echo "‚úÖ Periphery $(periphery version)"

      # ========================================
      # 4. –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û (~30-40 —Å–µ–∫)
      # ========================================
      - name: üé® –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∫–æ–¥–∞
        id: style-check
        continue-on-error: true
        run: |
          echo "üé® –ó–∞–ø—É—Å–∫–∞—é –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∏–ª—è..."
          ./tools/swift-style-check . --skip-build-check --format json --output style-report.json || true

          if [ -f "style-report.json" ]; then
            echo "‚úÖ –û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω"
            cat style-report.json | jq '.summary'
          else
            echo "‚ö†Ô∏è –û—Ç—á–µ—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback"
            echo '{"summary":{"errors":0,"warnings":0},"files":[]}' > style-report.json
          fi

      - name: üóëÔ∏è –ü–æ–∏—Å–∫ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –∫–æ–¥–∞
        id: dead-code
        continue-on-error: true
        run: |
          echo "üóëÔ∏è –ó–∞–ø—É—Å–∫–∞—é –ø–æ–∏—Å–∫ –º–µ—Ä—Ç–≤–æ–≥–æ –∫–æ–¥–∞..."

          # –ò—â–µ–º –ø—Ä–æ–µ–∫—Ç
          PROJECT=""
          if [ -n "$(find . -maxdepth 1 -name "*.xcworkspace" -type d)" ]; then
            PROJECT=$(find . -maxdepth 1 -name "*.xcworkspace" -type d | head -n 1)
          elif [ -n "$(find . -maxdepth 1 -name "*.xcodeproj" -type d)" ]; then
            PROJECT=$(find . -maxdepth 1 -name "*.xcodeproj" -type d | head -n 1)
          fi

          if [ -z "$PROJECT" ]; then
            echo "‚ö†Ô∏è Xcode –ø—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞—é"
            echo '{"summary":{"errors":0,"warnings":0,"infos":0},"issues":[]}' > dead-code-report.json
          else
            # –ü—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–¥–∞—Ç—å —Ñ–ª–∞–≥ --simulator –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è destination
            ./tools/swift-dead-code "$PROJECT" --simulator "iPhone 16" --format json --output dead-code-report.json 2>&1 || {
              echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –º–µ—Ä—Ç–≤–æ–≥–æ –∫–æ–¥–∞ (–ø—Ä–æ–±—É–µ–º –±–µ–∑ --simulator)"
              ./tools/swift-dead-code "$PROJECT" --skip-build --format json --output dead-code-report.json 2>&1 || {
                echo "‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ä—Ç–≤–æ–≥–æ –∫–æ–¥–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞ (–Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å CI –æ–∫—Ä—É–∂–µ–Ω–∏–µ–º)"
                echo '{"summary":{"errors":0,"warnings":0,"infos":0},"issues":[]}' > dead-code-report.json
              }
            }

            if [ -f "dead-code-report.json" ]; then
              echo "‚úÖ –û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω"
              cat dead-code-report.json | jq '.summary' || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å summary"
            else
              echo '{"summary":{"errors":0,"warnings":0,"infos":0},"issues":[]}' > dead-code-report.json
            fi
          fi

      - name: üíæ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏
        id: memory-check
        continue-on-error: true
        run: |
          echo "üíæ –ó–∞–ø—É—Å–∫–∞—é –ø—Ä–æ–≤–µ—Ä–∫—É –ø–∞–º—è—Ç–∏..."
          ./tools/swift-memory-check . --static-analysis --format json --output memory-report.json || true

          if [ -f "memory-report.json" ]; then
            echo "‚úÖ –û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω"
            cat memory-report.json | jq '.summary'
          else
            echo "‚ö†Ô∏è –û—Ç—á–µ—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω"
            echo '{"summary":{"errors":0,"warnings":0,"infos":0},"issues":[]}' > memory-report.json
          fi

      # ========================================
      # 5. –°–æ–∑–¥–∞–Ω–∏–µ —Å–≤–æ–¥–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ (~5 —Å–µ–∫)
      # ========================================
      - name: üìä –°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç
        if: always()
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë          üìä –°–í–û–î–ù–´–ô –û–¢–ß–ï–¢ CODE REVIEW                  ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "üìå –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}"
          echo "üîÄ –í–µ—Ç–∫–∞: ${{ github.ref_name }}"
          echo "üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}"
          echo "üìù Commit: ${{ github.sha }}"
          echo ""

          # –°—Ç–∏–ª—å –∫–æ–¥–∞
          if [ -f "style-report.json" ]; then
            STYLE_ERRORS=$(cat style-report.json | jq -r '.summary.errors // 0')
            STYLE_WARNINGS=$(cat style-report.json | jq -r '.summary.warnings // 0')
            echo "üé® –°—Ç–∏–ª—å –∫–æ–¥–∞: $STYLE_ERRORS –æ—à–∏–±–æ–∫, $STYLE_WARNINGS –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π"
          fi

          # –ú–µ—Ä—Ç–≤—ã–π –∫–æ–¥
          if [ -f "dead-code-report.json" ]; then
            DEAD_CODE=$(cat dead-code-report.json | jq -r '.summary.warnings // 0')
            echo "üóëÔ∏è –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–¥: $DEAD_CODE —ç–ª–µ–º–µ–Ω—Ç–æ–≤"
          fi

          # –£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏
          if [ -f "memory-report.json" ]; then
            MEM_ERRORS=$(cat memory-report.json | jq -r '.summary.errors // 0')
            MEM_WARNINGS=$(cat memory-report.json | jq -r '.summary.warnings // 0')
            echo "üíæ –£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏: $MEM_ERRORS –æ—à–∏–±–æ–∫, $MEM_WARNINGS –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π"
          fi

          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

      # ========================================
      # 6. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ JSON –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ backend (~5 —Å–µ–∫)
      # ========================================
      - name: üì§ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Ç—á–µ—Ç–∞ –¥–ª—è backend
        if: always()
        run: |
          # –°–æ–∑–¥–∞–µ–º –µ–¥–∏–Ω—ã–π JSON —Å–æ –≤—Å–µ–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
          cat > final-report.json <<EOF
          {
            "repository": "${{ github.repository }}",
            "branch": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "author": "${{ github.actor }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "workflow_run_id": "${{ github.run_id }}",
            "reports": {
              "style": $(cat style-report.json 2>/dev/null || echo 'null'),
              "dead_code": $(cat dead-code-report.json 2>/dev/null || echo 'null'),
              "memory": $(cat memory-report.json 2>/dev/null || echo 'null')
            }
          }
          EOF

          echo "üìÑ –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω:"
          cat final-report.json | jq '.'

      - name: üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ backend
        if: always()
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL }}
          BACKEND_TOKEN: ${{ secrets.BACKEND_TOKEN }}
        run: |
          if [ -z "$BACKEND_URL" ]; then
            echo "‚ö†Ô∏è BACKEND_URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
            echo "üí° –î–æ–±–∞–≤—å—Ç–µ secret BACKEND_URL –≤ Settings -> Secrets and variables -> Actions"
            exit 0
          fi

          echo "üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é –æ—Ç—á–µ—Ç –Ω–∞ backend..."

          RESPONSE=$(curl -X POST "$BACKEND_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $BACKEND_TOKEN" \
            -d @final-report.json \
            -w "\n%{http_code}" \
            -s)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ –û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (HTTP $HTTP_CODE)"
            echo "$BODY"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi

      # ========================================
      # 7. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤ GitHub
      # ========================================
      - name: üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-review-reports
          path: |
            style-report.json
            dead-code-report.json
            memory-report.json
            final-report.json
          retention-days: 7
